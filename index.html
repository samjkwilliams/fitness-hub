<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0f14" />
  <title>Fitness Hub</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b0f14;
      --surface: #121821;
      --surface-2: #182130;
      --text: #e8eef6;
      --muted: #9bb0c9;
      --accent: #4dd2ff;
      --accent-2: #7c5cff;
      --good: #38d39f;
      --warn: #ffb020;
      --danger: #ff5c5c;
      --border: #223047;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      letter-spacing: 0.2px;
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 22px 20px 12px;
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, rgba(11,15,20,0.96) 0%, rgba(11,15,20,0.6) 100%);
      backdrop-filter: blur(18px);
      z-index: 10;
      border-bottom: 1px solid var(--border);
    }

    header h1 {
      font-size: 20px;
      margin: 0;
      letter-spacing: 0.6px;
    }

    header p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    main {
      padding: 16px 20px 96px;
      flex: 1;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }

    .card h2 {
      font-size: 16px;
      margin: 0 0 8px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--surface-2);
      color: var(--muted);
      font-size: 12px;
      border: 1px solid var(--border);
    }

    .btn {
      border: none;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 600;
      color: #081019;
      background: var(--accent);
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      box-shadow: 0 10px 24px rgba(77,210,255,0.25);
    }

    .btn.secondary {
      background: var(--surface-2);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .btn.ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .btn.active-filter {
      color: var(--text);
      border-color: var(--accent);
      box-shadow: 0 6px 18px rgba(77,210,255,0.2);
    }

    .btn:active { transform: scale(0.98); }

    .tabs {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      padding: 10px 12px 20px;
      background: rgba(11,15,20,0.95);
      border-top: 1px solid var(--border);
      backdrop-filter: blur(12px);
    }

    .tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
    }

    .tab.active { color: var(--text); }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .program {
      padding: 12px;
      border-radius: 14px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .program h3 {
      margin: 0;
      font-size: 15px;
    }

    .program p {
      margin: 0;
      color: var(--muted);
      font-size: 12px;
      min-height: 32px;
    }

    .badge {
      font-size: 11px;
      color: var(--muted);
    }

    .workout-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .exercise {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: #101620;
    }

    .exercise h4 {
      margin: 0 0 6px;
      font-size: 14px;
    }

    .exercise small {
      color: var(--muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b111a;
      color: var(--text);
      font-size: 12px;
    }

    .set-row {
      display: grid;
      grid-template-columns: 26px 1fr 1fr 1fr 1fr;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }

    .set-row .set-done {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--muted);
      font-size: 12px;
    }

    .set-row .set-done.done {
      background: var(--good);
      color: #04110c;
      border-color: transparent;
      font-weight: 700;
    }

    .inline-note {
      color: var(--muted);
      font-size: 11px;
    }

    .timer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px 12px;
      background: #0c131e;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .timer .time {
      font-size: 20px;
      font-weight: 700;
    }

    .tag {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(124,92,255,0.2);
      color: #c7baff;
      font-size: 11px;
      border: 1px solid rgba(124,92,255,0.35);
    }

    .empty {
      color: var(--muted);
      font-size: 13px;
      text-align: center;
      padding: 20px 0;
    }

    .chart {
      width: 100%;
      height: 60px;
      background: #0c121c;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }

    .calendar-head {
      text-align: center;
      font-size: 11px;
      color: var(--muted);
      padding: 4px 0;
    }

    .calendar-cell {
      background: #0c131e;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 0;
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      position: relative;
    }

    .calendar-cell.today {
      border-color: var(--accent);
    }

    .calendar-cell.selected {
      background: rgba(77,210,255,0.2);
      border-color: var(--accent);
    }

    .calendar-cell.has-log .dot {
      width: 6px;
      height: 6px;
      background: var(--good);
      border-radius: 999px;
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 720px) {
      .split { grid-template-columns: 1fr; }
      .set-row { grid-template-columns: 26px 1fr 1fr; grid-template-rows: auto auto; }
      .set-row input:nth-child(4), .set-row input:nth-child(5) { grid-column: span 1; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Fitness Hub</h1>
      <p id="subtitle">Plan smart. Train hard. Track the wins.</p>
    </header>
    <main>
      <section id="view-today" class="view"></section>
      <section id="view-programs" class="view" style="display:none"></section>
      <section id="view-history" class="view" style="display:none"></section>
      <section id="view-settings" class="view" style="display:none"></section>
    </main>
  </div>

  <nav class="tabs">
    <div class="tab active" data-view="today">Today</div>
    <div class="tab" data-view="programs">Programs</div>
    <div class="tab" data-view="history">History</div>
    <div class="tab" data-view="settings">Settings</div>
  </nav>

  <script>
    const STORAGE_KEY = "fitness_hub_v1";
    const APP_VERSION = "v3.3.0";

    const CATEGORIES = [
      "All",
      "Favorites",
      "Hypertrophy",
      "Powerlifting",
      "Powerbuilding",
      "Strength",
      "Bodyweight",
      "General"
    ];

    const TOP_PROGRAMS = [
      // Hypertrophy (top 10)
      {
        id: "top-hyp-reddit-ppl",
        name: "Reddit PPL",
        category: "Hypertrophy",
        source: "Spreadsheet",
        file: "Hypertrophy/Template PPL Coolcicada _Fixed 4_16_20_ _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "phul-4",
        name: "PHUL",
        category: "Powerbuilding",
        source: "Built-in",
        tag: "Top 10"
      },
      {
        id: "top-hyp-phat",
        name: "PHAT",
        category: "Powerbuilding",
        source: "Spreadsheet",
        file: "Powerlifting/PHAT Workout Log TEMPLATE _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-hyp-israetel",
        name: "Mike Israetel 5 Week Hypertrophy",
        category: "Hypertrophy",
        source: "Spreadsheet",
        file: "Hypertrophy/Dr. Mike Israetel Training Volume Landmarks Hypertrophy Routine _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-hyp-bigcoachd",
        name: "BigCoachD 8 Week Hypertrophy",
        category: "Hypertrophy",
        source: "Spreadsheet",
        file: "Hypertrophy/8 Week Hypertrophy Block - BigCoachD _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-hyp-starscream",
        name: "Starscream 12 Week Hypertrophy",
        category: "Hypertrophy",
        source: "Spreadsheet",
        file: "Hypertrophy/Starscream (autoregulated hypertrophy program) _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-hyp-rippedbody-int",
        name: "Ripped Body Intermediate Bodybuilding",
        category: "Hypertrophy",
        source: "Spreadsheet",
        file: "Hypertrophy/Ripped Body Intermediate Bodybuilding Routine _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-hyp-strong-curves",
        name: "Strong Curves",
        category: "Hypertrophy",
        source: "Spreadsheet",
        file: "Powerlifting/Bootyful Beginnings - Strong Curves Spreadsheets _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-hyp-gzclp-hyp",
        name: "GZCLP for Hypertrophy",
        category: "Hypertrophy",
        source: "Spreadsheet",
        file: "Hypertrophy/GZCLP for Hypertrophy - 4 Day _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-hyp-gironda-8x8",
        name: "Vince Gironda 8x8",
        category: "Hypertrophy",
        source: "Spreadsheet",
        file: "Hypertrophy/[4 Day - Advanced] Vince Gironda 8x8 Workout Routine Spreadsheet _ LiftVault.com_.xlsx",
        tag: "Top 10"
      },

      // Powerlifting (top 10)
      {
        id: "top-pl-calgary",
        name: "Calgary Barbell 8/16 Week",
        category: "Powerlifting",
        source: "Spreadsheet",
        file: "Powerlifting/16 Week Complete Program - Calgary Barbell.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-pl-bullmastiff",
        name: "Bullmastiff",
        category: "Powerlifting",
        source: "Spreadsheet",
        file: "Powerlifting/Bullmastiff Strength Program (Empire Barbell) - LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-pl-sheiko",
        name: "Sheiko Programs",
        category: "Powerlifting",
        source: "Spreadsheet",
        file: "Hypertrophy/Sheiko Modified Hypertrophy v4.0 _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-pl-candito",
        name: "Candito 6 Week",
        category: "Powerlifting",
        source: "Spreadsheet",
        file: "Powerlifting/Candito 6 Week Intermediate + Advanced Bench Program Combined (old version) _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-pl-juggernaut",
        name: "Juggernaut Method",
        category: "Powerlifting",
        source: "Spreadsheet",
        file: "Powerlifting/Inverse-Juggernaut-Blank-Template _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-pl-nuckols",
        name: "Greg Nuckols Beginner Powerlifting",
        category: "Powerlifting",
        source: "Spreadsheet",
        file: "Powerlifting/Greg Nuckols General Beginner Powerlifting Program - LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-pl-nsuns",
        name: "nSuns LP",
        category: "Powerlifting",
        source: "Spreadsheet",
        file: "Powerlifting/nSuns Linear Progression (LP) Complete Bundle (4 Day, 5 Day, 6 Day squat, 6 Day deadlift) _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-pl-531",
        name: "Wendler 5/3/1",
        category: "Powerlifting",
        source: "Spreadsheet",
        file: "Powerlifting/Wendler 5_3_1 Spreadsheet _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-pl-texas",
        name: "Texas Method",
        category: "Powerlifting",
        source: "Spreadsheet",
        file: "Powerlifting/Texas Method Spreadsheet _ LiftVault.com.xlsx",
        tag: "Top 10"
      },
      {
        id: "top-pl-gzclp",
        name: "GZCLP",
        category: "Powerlifting",
        source: "Spreadsheet",
        file: "Powerlifting/v4_5b5 GZCLP 3-4 Day 12-Week _ LiftVault.com.xlsx",
        tag: "Top 10"
      }
    ];

    const curatedPrograms = [
      {
        id: "ppl-6",
        name: "Push / Pull / Legs (6-day)",
        focus: "Hypertrophy volume + frequency",
        days: [
          workout("Push A", [
            ex("Bench Press", 4, "6-8", 120),
            ex("Overhead Press", 3, "8-10", 120),
            ex("Incline DB Press", 3, "10-12", 90),
            ex("Lateral Raise", 3, "12-15", 60),
            ex("Triceps Pressdown", 3, "12-15", 60)
          ]),
          workout("Pull A", [
            ex("Deadlift", 3, "4-6", 180),
            ex("Pull-Up", 3, "6-10", 120),
            ex("Barbell Row", 3, "8-10", 120),
            ex("Face Pull", 3, "12-15", 60),
            ex("EZ Curl", 3, "10-12", 60)
          ]),
          workout("Legs A", [
            ex("Back Squat", 4, "5-8", 180),
            ex("Romanian Deadlift", 3, "8-10", 120),
            ex("Leg Press", 3, "10-12", 120),
            ex("Leg Curl", 3, "12-15", 60),
            ex("Calf Raise", 4, "10-15", 60)
          ]),
          workout("Push B", [
            ex("Incline Bench", 4, "6-8", 120),
            ex("Dumbbell Shoulder Press", 3, "8-10", 90),
            ex("Cable Fly", 3, "12-15", 60),
            ex("Lateral Raise", 3, "12-15", 60),
            ex("Overhead Triceps Ext", 3, "10-12", 60)
          ]),
          workout("Pull B", [
            ex("Barbell Row", 4, "6-8", 120),
            ex("Lat Pulldown", 3, "8-10", 90),
            ex("Seated Cable Row", 3, "10-12", 90),
            ex("Rear Delt Fly", 3, "12-15", 60),
            ex("Hammer Curl", 3, "10-12", 60)
          ]),
          workout("Legs B", [
            ex("Front Squat", 4, "5-8", 150),
            ex("Hip Thrust", 3, "8-10", 120),
            ex("Bulgarian Split Squat", 3, "8-10", 90),
            ex("Leg Extension", 3, "12-15", 60),
            ex("Calf Raise", 4, "10-15", 60)
          ])
        ]
      },
      {
        id: "upper-lower-4",
        name: "Upper / Lower (4-day)",
        focus: "Balanced strength + size",
        days: [
          workout("Upper A", [
            ex("Bench Press", 4, "5-8", 150),
            ex("Row (Barbell)", 4, "6-8", 150),
            ex("Overhead Press", 3, "8-10", 120),
            ex("Pull-Up", 3, "6-10", 120),
            ex("DB Curl", 3, "10-12", 60)
          ]),
          workout("Lower A", [
            ex("Back Squat", 4, "5-8", 180),
            ex("Romanian Deadlift", 3, "8-10", 120),
            ex("Leg Press", 3, "10-12", 120),
            ex("Leg Curl", 3, "12-15", 60)
          ]),
          workout("Upper B", [
            ex("Incline Bench", 4, "6-8", 120),
            ex("Lat Pulldown", 4, "8-10", 90),
            ex("Dumbbell Shoulder Press", 3, "8-10", 90),
            ex("Chest Fly", 3, "12-15", 60),
            ex("Triceps Pressdown", 3, "10-12", 60)
          ]),
          workout("Lower B", [
            ex("Deadlift", 3, "3-5", 180),
            ex("Front Squat", 3, "6-8", 150),
            ex("Hip Thrust", 3, "8-10", 120),
            ex("Calf Raise", 4, "10-15", 60)
          ])
        ]
      },
      {
        id: "full-body-3",
        name: "Full Body (3-day)",
        focus: "Minimal time, maximal progress",
        days: [
          workout("Full Body A", [
            ex("Back Squat", 3, "5-8", 180),
            ex("Bench Press", 3, "6-8", 150),
            ex("Row (Barbell)", 3, "8-10", 120),
            ex("Lateral Raise", 2, "12-15", 60)
          ]),
          workout("Full Body B", [
            ex("Deadlift", 3, "3-5", 180),
            ex("Overhead Press", 3, "6-8", 120),
            ex("Pull-Up", 3, "6-10", 120),
            ex("Leg Curl", 2, "12-15", 60)
          ]),
          workout("Full Body C", [
            ex("Front Squat", 3, "6-8", 150),
            ex("Incline Bench", 3, "8-10", 120),
            ex("Lat Pulldown", 3, "8-10", 90),
            ex("Calf Raise", 3, "12-15", 60)
          ])
        ]
      },
      {
        id: "stronglifts-5x5",
        name: "StrongLifts 5x5",
        focus: "Simple strength progression",
        days: [
          workout("Workout A", [
            ex("Back Squat", 5, "5", 180),
            ex("Bench Press", 5, "5", 180),
            ex("Barbell Row", 5, "5", 180)
          ]),
          workout("Workout B", [
            ex("Back Squat", 5, "5", 180),
            ex("Overhead Press", 5, "5", 180),
            ex("Deadlift", 1, "5", 180)
          ])
        ]
      },
      {
        id: "phul-4",
        name: "PHUL (4-day)",
        focus: "Power + Hypertrophy split",
        days: [
          workout("Upper Power", [
            ex("Bench Press", 4, "3-5", 180),
            ex("Row (Barbell)", 4, "3-5", 180),
            ex("Overhead Press", 3, "5-8", 150),
            ex("Pull-Up", 3, "5-8", 150)
          ]),
          workout("Lower Power", [
            ex("Back Squat", 4, "3-5", 180),
            ex("Deadlift", 3, "3-5", 180),
            ex("Leg Press", 3, "6-10", 120)
          ]),
          workout("Upper Hypertrophy", [
            ex("Incline Bench", 4, "8-12", 120),
            ex("Lat Pulldown", 4, "10-12", 90),
            ex("Dumbbell Shoulder Press", 3, "10-12", 90),
            ex("Cable Fly", 3, "12-15", 60)
          ]),
          workout("Lower Hypertrophy", [
            ex("Front Squat", 4, "8-12", 150),
            ex("Romanian Deadlift", 3, "10-12", 120),
            ex("Leg Curl", 3, "12-15", 60),
            ex("Calf Raise", 4, "12-15", 60)
          ])
        ]
      },
      {
        id: "xframe",
        name: "X-Frame Hypertrophy (Phase 1)",
        focus: "Chest/Shoulder push, Pull A/B, Legs + Hamstring focus",
        days: [
          workout("Chest Focused Push", [
            ex("Lateral Raise Machine", 4, "10-15", 60, [
              "DB Lateral Raise",
              "Cable Lateral Raise",
              "Machine Lateral Raise"
            ]),
            ex("Flat DB Press", 3, "8-12", 90, [
              "Smith Machine Press",
              "Machine Chest Press"
            ]),
            ex("Incline Hammer Strength Chest Press", 3, "8-12", 90, [
              "Incline Barbell Press",
              "Incline DB Press"
            ]),
            ex("Pec Deck Fly", 2, "10-15", 60, [
              "Cable Fly",
              "Machine Fly"
            ]),
            ex("Reverse Pec Deck Fly", 3, "12-20", 60, [
              "Reverse Cable Fly",
              "Reverse Pec Deck"
            ]),
            ex("Shoulder Width Overhand Pushdown", 4, "12-20", 60, [
              "Rope Pushdown",
              "Straight Bar Pushdown"
            ]),
            ex("Abdominal Crunch", 4, "10-15", 60, [
              "Rope Crunch",
              "Hip Raise",
              "GHR Crunch"
            ])
          ]),
          workout("Pull A", [
            ex("Lat Bias Pulldown", 3, "8-12", 90, [
              "Single Arm Cable Pulldown",
              "Nautilus/Hammer Strength High Row"
            ]),
            ex("Upper Back Bias Row", 2, "8-12", 90, [
              "T Bar Row",
              "DB Incline Bench Row"
            ]),
            ex("Lat Bias Row", 3, "10-15", 90, [
              "Single Arm Cable Row",
              "Prime Row",
              "Hammer Strength Row",
              "Single Arm Landmine Row"
            ]),
            ex("Upper Back Bias Row (Steeper Angle)", 2, "12-20", 90, [
              "Hammer Strength Iso Row",
              "Bent DB Row"
            ]),
            ex("DB Preacher Curl", 3, "10-15", 60, [
              "Machine Preacher Curl",
              "DB Curl"
            ]),
            ex("Hammer Cable Curl", 3, "10-15", 60, [
              "DB Hammer Curl",
              "Cable Curl"
            ]),
            ex("DB Wrist Extension", 2, "12-15", 45, [])
          ]),
          workout("Legs", [
            ex("Seated Hamstring Curl", 4, "8-12", 60, [
              "Prone DB Hamstring Curl",
              "Seated Hamstring Curl (Any Machine)"
            ]),
            ex("Squat of Choice", 2, "8-12", 120, [
              "SSB Squat",
              "Hack Squat",
              "Rogers Squat"
            ]),
            ex("Leg Press of Choice", 3, "12-20", 90, [
              "45 Degree Leg Press",
              "Cybex Leg Press"
            ]),
            ex("Adductor", 2, "10-15", 60, [
              "Cable Adductor"
            ]),
            ex("Quad Extension", 3, "10-15", 60, [
              "Leg Extension (Any Machine)"
            ]),
            ex("Straight Leg Calf Raise", 4, "12-16", 60, [
              "Donkey Calf Raise",
              "Standing Calf Raise"
            ])
          ]),
          workout("Shoulder Focused Push", [
            ex("Machine Lateral Raise", 4, "10-15", 60, [
              "Cable Lateral Raise",
              "DB Lateral Raise"
            ]),
            ex("Shoulder Press Machine of Choice", 3, "8-12", 90, [
              "DB Shoulder Press",
              "BB Military Press",
              "Machine Shoulder Press"
            ]),
            ex("Close Grip Press", 3, "8-12", 90, [
              "Smith Close Grip Press",
              "Machine Press"
            ]),
            ex("Reverse Cable Fly", 3, "10-15", 60, [
              "Reverse Pec Deck",
              "Cable Reverse Fly"
            ]),
            ex("Chest Cable Fly", 3, "10-15", 60, [
              "Pec Deck Fly",
              "Cable Fly"
            ]),
            ex("Overhead Tricep Extension", 4, "10-15", 60, [
              "DB Overhead Tricep Extension",
              "Cable Overhead Tricep Extension"
            ]),
            ex("Abdominal Crunch", 4, "10-15", 60, [
              "Rope Crunch",
              "Hip Raise",
              "GHR Crunch"
            ])
          ]),
          workout("Pull B", [
            ex("Upper Back Bias Pulldown", 3, "10-15", 90, [
              "Cable Pulldown",
              "Machine Pulldown"
            ]),
            ex("Upper Back Bias Row", 3, "8-12", 90, [
              "Chest Supported T Bar Row",
              "DB Row",
              "Horizontal Row Machine"
            ]),
            ex("Lat Row of Choice", 2, "8-12", 90, [
              "Seated Cable Row",
              "Machine Row"
            ]),
            ex("Lat Pulldown of Choice", 2, "12-20", 90, [
              "Single Arm Cable Pulldown",
              "Bilateral Cable Pulldown",
              "Machine Pulldown"
            ]),
            ex("Incline Cable Curl", 3, "10-15", 60, [
              "Incline Bench DB Curl",
              "Machine Curl"
            ]),
            ex("Preacher DB Hammer Curl", 3, "10-15", 60, [
              "Cable Preacher Curl",
              "Machine Preacher Curl",
              "DB Curl"
            ]),
            ex("DB Wrist Extension", 2, "12-15", 45, [])
          ]),
          workout("Hamstring Focused Leg Day", [
            ex("Lying Hamstring Curl", 4, "8-12", 60, [
              "Any Hamstring Curl Machine"
            ]),
            ex("RDL", 2, "8-12", 120, [
              "Barbell RDL",
              "DB RDL",
              "Pit Shark RDL"
            ]),
            ex("Front Foot Elevated Split Squat or Single Leg Press", 3, "10-15", 90, [
              "DB Split Squat",
              "Smith Split Squat",
              "Hip Press (Single Leg)"
            ]),
            ex("Adductor", 3, "10-15", 60, [
              "Cable Adductor"
            ]),
            ex("Straight Leg Calf Raise", 4, "6-10", 60, [
              "Donkey Calf Raise",
              "Standing Calf Raise"
            ])
          ])
        ]
      }
    ];

    function ex(name, sets, reps, rest, alternatives = []) {
      return { name, sets, reps, rest, notes: "", alternatives };
    }

    function workout(name, exercises) {
      return { name, exercises };
    }

    function inferCategory(program) {
      const name = (program.name || "").toLowerCase();
      if (name.includes("x-frame") || name.includes("hypertrophy") || name.includes("bodybuilding") || name.includes("ppl") || name.includes("phat")) {
        return "Hypertrophy";
      }
      if (name.includes("powerlifting") || name.includes("calgary") || name.includes("sheiko") || name.includes("nsuns") || name.includes("texas method")) {
        return "Powerlifting";
      }
      if (name.includes("phul") || name.includes("power") || name.includes("strength_hypertrophy")) {
        return "Powerbuilding";
      }
      if (name.includes("stronglifts") || name.includes("5x5") || name.includes("strength")) {
        return "Strength";
      }
      if (name.includes("bodyweight") || name.includes("calisthenics")) {
        return "Bodyweight";
      }
      return "General";
    }

    function buildProgramCatalog() {
      const topMap = new Map(TOP_PROGRAMS.map(program => [program.id, program]));
      const builtIns = state.programs.map(program => ({
        id: program.id,
        name: program.name,
        focus: program.focus,
        daysCount: program.days.length,
        category: program.category || inferCategory(program),
        source: program.source || "Built-in",
        templateOnly: false,
        tag: topMap.get(program.id)?.tag || "Included"
      }));

      const topPrograms = TOP_PROGRAMS.filter(program => program.source === "Spreadsheet").map(program => ({
        ...program,
        focus: program.category,
        daysCount: null,
        templateOnly: program.source === "Spreadsheet"
      }));

      const unique = new Map();
      [...builtIns, ...topPrograms].forEach(program => {
        unique.set(program.id, program);
      });
      return Array.from(unique.values());
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          parsed.dayOverrides = parsed.dayOverrides || {};
          parsed.activeDate = parsed.activeDate || new Date().toISOString().slice(0, 10);
          parsed.units = parsed.units || "lb";
          parsed.calendarMonth = parsed.calendarMonth || parsed.activeDate.slice(0, 7);
          parsed.favorites = parsed.favorites || [];
          parsed.programFilter = parsed.programFilter || "All";
          parsed.programs = (parsed.programs || []).map(program => ({
            ...program,
            category: program.category || inferCategory(program),
            source: program.source || "Built-in"
          }));
          return parsed;
        } catch (err) {
          console.warn("Failed to parse storage", err);
        }
      }
      return {
        programs: curatedPrograms.map(program => ({
          ...program,
          category: inferCategory(program),
          source: "Built-in"
        })),
        activeProgramId: curatedPrograms[0].id,
        programStart: new Date().toISOString().slice(0, 10),
        logs: {},
        dayOverrides: {},
        activeDate: new Date().toISOString().slice(0, 10),
        units: "lb",
        calendarMonth: new Date().toISOString().slice(0, 7),
        favorites: [],
        programFilter: "All"
      };
    }

    function saveState(state) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    function getActiveProgram() {
      return state.programs.find(p => p.id === state.activeProgramId) || state.programs[0];
    }

    function getTodayKey() {
      return state.activeDate || formatDateKey(new Date());
    }

    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function dayIndexForProgram(program, dateKey) {
      const start = new Date(state.programStart);
      const target = new Date(dateKey);
      const diffDays = Math.floor((target - start) / (1000 * 60 * 60 * 24));
      const index = ((diffDays % program.days.length) + program.days.length) % program.days.length;
      const week = Math.floor(diffDays / program.days.length) + 1;
      return { index, week, diffDays };
    }

    function getDayIndexForDate(program, dateKey) {
      const override = state.dayOverrides?.[dateKey];
      if (override !== undefined && override !== null) {
        return { index: override, week: "-", diffDays: 0, overridden: true };
      }
      const result = dayIndexForProgram(program, dateKey);
      return { ...result, overridden: false };
    }

    function render() {
      updateSubtitle();
      renderToday();
      renderPrograms();
      renderHistory();
      renderSettings();
    }

    function renderToday() {
      const view = document.getElementById("view-today");
      const program = getActiveProgram();
      const todayKey = getTodayKey();
      const { index, week, overridden } = getDayIndexForDate(program, todayKey);
      const workoutPlan = program.days[index];
      const log = state.logs[todayKey];
      const isCompleted = log && log.completed;
      const summary = isCompleted ? buildWorkoutSummary(log) : null;

      view.innerHTML = `
        <div class="card">
          <h2>Today · ${formatDate(todayKey)}</h2>
          <div class="row">
            <span class="pill">Program: ${program.name}</span>
            <span class="pill">Week ${week}</span>
            <span class="pill">Day ${index + 1}</span>
            ${isCompleted ? '<span class="pill" style="color:var(--good)">Completed</span>' : ''}
          </div>
          <div style="margin-top:10px" class="row">
            <div style="flex:1">
              <label class="inline-note">Log date</label>
              <input type="date" value="${todayKey}" onchange="setActiveDate(this.value)" />
            </div>
            <div style="flex:1">
              <label class="inline-note">Pick day</label>
              <select onchange="updateDayOverride(this.value)">
                ${program.days.map((day, dayIndex) => `
                  <option value="${dayIndex}" ${dayIndex === index ? "selected" : ""}>${day.name}</option>
                `).join("")}
              </select>
            </div>
            ${overridden ? '<button class="btn ghost" onclick="clearDayOverride()">Use schedule</button>' : ''}
          </div>
        </div>
        <div class="card">
          <h2>${workoutPlan.name}</h2>
          ${workoutPlan.exercises.length === 0 ? '<p class="empty">No exercises yet. Add them in Programs → Edit (coming soon) or choose another program for tonight.</p>' : ''}
          <div class="workout-list">
            ${workoutPlan.exercises.map((exercise, exIndex) => renderExercise(exercise, exIndex, log)).join("")}
          </div>
          <div style="margin-top:12px" class="row">
            <button class="btn" onclick="startWorkout()">Start / Resume</button>
            <button class="btn secondary" onclick="saveWorkout(true)">Finish & Save</button>
            <button class="btn ghost" onclick="resetToday()">Reset</button>
          </div>
        </div>
        ${summary ? `
        <div class="card">
          <h2>Workout Summary</h2>
          <div class="row">
            <span class="pill">Volume: ${formatVolume(summary.totalVolume)}</span>
            <span class="pill">Sets done: ${summary.totalSets}</span>
          </div>
          <div style="margin-top:10px">
            ${summary.exerciseVolumes.slice(0, 3).map(item => `
              <div class="inline-note">${item.name}: ${Math.round(item.volume)} lb</div>
            `).join("") || '<div class="inline-note">No logged volume yet.</div>'}
          </div>
          ${summary.prHighlights.length ? `
            <div style="margin-top:10px">
              <div class="inline-note">New PRs</div>
              ${summary.prHighlights.slice(0, 3).map(item => `
                <div class="inline-note">${item.name}: ${item.weight} x ${item.reps} (1RM ${item.e1rm.toFixed(1)})</div>
              `).join("")}
            </div>
          ` : ""}
        </div>
        ` : ""}
        <div class="card">
          <h2>Rest Timer</h2>
          <div class="timer">
            <div>
              <div class="time" id="rest-timer">02:00</div>
              <div class="inline-note">Tap a set to auto-start rest.</div>
            </div>
            <div class="row">
              <button class="btn secondary" onclick="timerStart(120)">Start 2:00</button>
              <button class="btn ghost" onclick="timerStop()">Stop</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderExercise(exercise, exIndex, log) {
      const sets = getSetsForExercise(exercise, exIndex, log);
      const selectedName = getSelectedExerciseName(exIndex, exercise, log);
      const history = getExerciseHistory(selectedName, 3);
      const pr = getExercisePR(selectedName, getTodayKey());
      const last = history[0];
      const currentBest = getBestSet(log?.exercises?.[exIndex]?.sets || []);
      const hasNewPR = currentBest && (!pr || currentBest.e1rm > pr.best1rm);
      const lastLine = last ? `Last: ${last.weight} x ${last.reps} (${formatDate(last.date)})` : "No history yet";
      const prLine = pr ? `PR 1RM: ${pr.best1rm.toFixed(1)}` : "PR 1RM: --";

      const alternatives = exercise.alternatives || [];
      const options = [exercise.name, ...alternatives];

      return `
        <div class="exercise">
          <div class="row" style="justify-content: space-between">
            <div>
              <h4>${selectedName}</h4>
              <small>${exercise.sets} sets · ${exercise.reps} reps · ${exercise.rest}s rest</small>
              ${selectedName !== exercise.name ? `<div class="inline-note">Prescribed: ${exercise.name}</div>` : ""}
            </div>
            <div class="row">
              ${hasNewPR ? '<span class="tag" style="color:var(--good)">New PR</span>' : ''}
              <span class="tag">${prLine}</span>
              <span class="tag">${lastLine}</span>
            </div>
          </div>
          ${last ? `
            <div class="row" style="margin-top:8px">
              <button class="btn ghost" onclick="fillNextSet(${exIndex}, ${last.weight}, ${last.reps})">Use last: ${last.weight} x ${last.reps}</button>
            </div>
          ` : ""}
          ${alternatives.length ? `
            <div style="margin-top:10px">
              <label class="inline-note">Smart substitute</label>
              <select onchange="updateExerciseSelection(${exIndex}, this.value)">
                ${buildSelectOptions(options, selectedName)}
              </select>
            </div>
          ` : ""}
          <div style="margin-top:10px">
            ${sets.map((set, idx) => renderSetRow(exIndex, idx, set)).join("")}
          </div>
          ${renderHistoryPreview(history)}
          <div class="row" style="margin-top:8px">
            <button class="btn secondary" onclick="addSet(${exIndex})">+ Set</button>
            <button class="btn ghost" onclick="duplicateLast(${exIndex})">Copy Last</button>
          </div>
        </div>
      `;
    }

    function renderSetRow(exIndex, setIndex, set) {
      return `
        <div class="set-row">
          <div class="set-done ${set.done ? 'done' : ''}" onclick="toggleSet(${exIndex}, ${setIndex})">${set.done ? '✓' : setIndex + 1}</div>
          <input type="number" inputmode="decimal" placeholder="Weight" value="${set.weight ?? ''}" onchange="updateSet(${exIndex}, ${setIndex}, 'weight', this.value)" />
          <input type="number" inputmode="decimal" placeholder="Reps" value="${set.reps ?? ''}" onchange="updateSet(${exIndex}, ${setIndex}, 'reps', this.value)" />
          <input type="number" inputmode="decimal" placeholder="RPE" value="${set.rpe ?? ''}" onchange="updateSet(${exIndex}, ${setIndex}, 'rpe', this.value)" />
          <input type="text" placeholder="Notes" value="${set.notes ?? ''}" onchange="updateSet(${exIndex}, ${setIndex}, 'notes', this.value)" />
        </div>
      `;
    }

    function renderPrograms() {
      const view = document.getElementById("view-programs");
      const catalog = buildProgramCatalog();
      const favorites = new Set(state.favorites || []);
      const filter = state.programFilter || "All";
      const visible = catalog.filter(program => {
        if (filter === "All") return true;
        if (filter === "Favorites") return favorites.has(program.id);
        return program.category === filter;
      });
      const sorted = visible.sort((a, b) => {
        const aFav = favorites.has(a.id) ? 1 : 0;
        const bFav = favorites.has(b.id) ? 1 : 0;
        if (aFav !== bFav) return bFav - aFav;
        return a.name.localeCompare(b.name);
      });
      view.innerHTML = `
        <div class="card">
          <h2>Programs</h2>
          <p class="inline-note">Choose a program and set a new start date. Programs are curated to match top app UX: simple templates, quick logging, and repeatable progress.</p>
          <div class="row" style="margin-top:10px">
            ${CATEGORIES.map(category => `
              <button class="btn ghost ${filter === category ? "active-filter" : ""}" onclick="setProgramFilter('${category}')">${category}</button>
            `).join("")}
          </div>
        </div>
        <div class="grid">
          ${sorted.map(program => `
            <div class="program">
              <h3>${program.name}</h3>
              <p>${program.focus || program.category}</p>
              <div class="row">
                ${program.daysCount ? `<span class="badge">${program.daysCount} days</span>` : '<span class="badge">Template</span>'}
                <span class="badge">${program.category}</span>
                ${program.tag ? `<span class="badge">${program.tag}</span>` : ""}
                ${program.id === state.activeProgramId ? '<span class="badge" style="color:var(--good)">Active</span>' : ''}
              </div>
              ${program.file ? `<div class="inline-note">Source: ${program.file}</div>` : ""}
              <div class="row" style="margin-top:8px">
                ${program.templateOnly
                  ? `<button class="btn ghost" onclick="alert('This program is stored as a spreadsheet. Importing full workouts is the next step.')">Spreadsheet Only</button>`
                  : `<button class="btn" onclick="setActiveProgram('${program.id}')">Set Active</button>
                     <button class="btn secondary" onclick="previewProgram('${program.id}')">Preview</button>`
                }
                <button class="btn secondary" onclick="toggleFavorite('${program.id}')">${favorites.has(program.id) ? "★ Favorite" : "☆ Favorite"}</button>
              </div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function renderHistory() {
      const view = document.getElementById("view-history");
      const logs = Object.entries(state.logs).sort((a,b) => b[0].localeCompare(a[0]));
      const topExercises = buildExerciseTrends();
      const calendar = buildCalendar(new Date(state.activeDate));

      view.innerHTML = `
        <div class="card">
          <h2>Progress</h2>
          <div class="split">
            <div>
              <p class="inline-note">Best estimated 1RM per exercise (Epley). Tap any row in history to see details.</p>
              <table>
                <thead>
                  <tr><th>Exercise</th><th>Best 1RM</th><th>Last</th></tr>
                </thead>
                <tbody>
                  ${topExercises.map(row => `
                    <tr>
                      <td>${row.name}</td>
                      <td>${row.best1rm.toFixed(1)}</td>
                      <td>${row.lastWeight} x ${row.lastReps}</td>
                    </tr>
                  `).join("") || '<tr><td colspan="3">No data yet.</td></tr>'}
                </tbody>
              </table>
            </div>
            <div>
              <canvas class="chart" id="chart"></canvas>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Calendar</h2>
          <div class="row" style="margin-bottom:10px">
            <button class="btn ghost" onclick="changeCalendarMonth(-1)">Prev</button>
            <span class="pill">${calendar.label}</span>
            <button class="btn ghost" onclick="changeCalendarMonth(1)">Next</button>
            <button class="btn secondary" onclick="goToToday()">Today</button>
          </div>
          <div class="calendar-grid">
            ${calendar.weekdays.map(day => `<div class="calendar-head">${day}</div>`).join("")}
            ${calendar.cells.map(cell => cell.disabled ? `
              <div></div>
            ` : `
              <button class="calendar-cell ${cell.isToday ? "today" : ""} ${cell.hasLog ? "has-log" : ""} ${cell.isSelected ? "selected" : ""}"
                onclick="setActiveDate('${cell.dateKey}')">
                <div>${cell.day}</div>
                ${cell.hasLog ? '<div class="dot"></div>' : ''}
              </button>
            `).join("")}
          </div>
          <div class="inline-note" style="margin-top:8px">Tap a day to log or edit that date.</div>
        </div>
        <div class="card">
          <h2>Selected Day</h2>
          ${renderSelectedDaySummary()}
        </div>
        <div class="card">
          <h2>Workout History</h2>
          ${logs.length === 0 ? '<p class="empty">No workouts logged yet.</p>' : ''}
          <div class="workout-list">
            ${logs.map(([date, log]) => `
              <div class="exercise">
                <div class="row" style="justify-content: space-between">
                  <div>
                    <h4>${formatDate(date)}</h4>
                    <small>${log.programName || ''} · ${log.workoutName || ''}</small>
                  </div>
                  <span class="tag">${formatVolume(log.totalVolume ?? calculateVolume(log))}</span>
                </div>
                <div class="inline-note" style="margin-top:6px">${log.notes || ""}</div>
              </div>
            `).join("")}
          </div>
        </div>
      `;

      drawChart(topExercises);
    }

    function renderSettings() {
      const view = document.getElementById("view-settings");
      view.innerHTML = `
        <div class="card">
          <h2>Settings</h2>
          <div class="row">
            <div style="flex:1">
              <label class="inline-note">Program start date</label>
              <input type="date" value="${state.programStart}" onchange="updateStartDate(this.value)" />
            </div>
            <div style="flex:1">
              <label class="inline-note">Units</label>
              <select onchange="setUnits(this.value)">
                <option value="lb" ${state.units === "lb" ? "selected" : ""}>Pounds (lb)</option>
                <option value="kg" ${state.units === "kg" ? "selected" : ""}>Kilograms (kg)</option>
              </select>
            </div>
            <div style="flex:1">
              <label class="inline-note">Export / Import data</label>
              <div class="row">
                <button class="btn secondary" onclick="exportData()">Export</button>
                <button class="btn ghost" onclick="importData()">Import</button>
              </div>
            </div>
          </div>
          <div style="margin-top:12px">
            <label class="inline-note">Quick notes</label>
            <textarea id="global-notes" rows="3" placeholder="Anything about your training week…"></textarea>
          </div>
        </div>
        <div class="card">
          <h2>App Version</h2>
          <div class="inline-note">You are viewing build ${APP_VERSION}.</div>
        </div>
        <div class="card">
          <h2>Tips for iPhone</h2>
          <ul class="inline-note">
            <li>Open this file in Safari, tap Share → Add to Home Screen for a near-native app feel.</li>
            <li>Your data is saved locally on your phone (offline-friendly).</li>
          </ul>
        </div>
      `;
    }

    function getSetsForExercise(exercise, exIndex, log) {
      const defaultSets = Array.from({ length: exercise.sets }).map(() => ({ weight: "", reps: "", rpe: "", notes: "", done: false }));
      if (!log || !log.exercises || !log.exercises[exIndex]) {
        return defaultSets;
      }
      const saved = log.exercises[exIndex].sets;
      if (saved.length >= defaultSets.length) return saved;
      return [...saved, ...defaultSets.slice(saved.length)];
    }

    function ensureTodayLog() {
      const today = getTodayKey();
      if (!state.logs[today]) {
        const program = getActiveProgram();
        const { index } = getDayIndexForDate(program, today);
        const workoutPlan = program.days[index];
        state.logs[today] = {
          programId: program.id,
          programName: program.name,
          workoutName: workoutPlan.name,
          exercises: workoutPlan.exercises.map(exercise => ({
            name: exercise.name,
            selectedName: exercise.name,
            sets: Array.from({ length: exercise.sets }).map(() => ({ weight: "", reps: "", rpe: "", notes: "", done: false }))
          }))
        };
        saveState(state);
      }
    }

    function startWorkout() {
      ensureTodayLog();
      render();
    }

    function updateSet(exIndex, setIndex, field, value) {
      ensureTodayLog();
      const today = getTodayKey();
      state.logs[today].exercises[exIndex].sets[setIndex][field] = value;
      saveState(state);
    }

    function fillNextSet(exIndex, weight, reps) {
      ensureTodayLog();
      const today = getTodayKey();
      const sets = state.logs[today].exercises[exIndex].sets;
      const target = sets.find(set => !set.weight || !set.reps) || sets[sets.length - 1];
      target.weight = String(weight);
      target.reps = String(reps);
      saveState(state);
      render();
    }

    function updateExerciseSelection(exIndex, value) {
      ensureTodayLog();
      const today = getTodayKey();
      state.logs[today].exercises[exIndex].selectedName = value;
      saveState(state);
      render();
    }

    function toggleSet(exIndex, setIndex) {
      ensureTodayLog();
      const today = getTodayKey();
      const set = state.logs[today].exercises[exIndex].sets[setIndex];
      set.done = !set.done;
      if (set.done) {
        timerStart(90);
      }
      saveState(state);
      render();
    }

    function addSet(exIndex) {
      ensureTodayLog();
      const today = getTodayKey();
      state.logs[today].exercises[exIndex].sets.push({ weight: "", reps: "", rpe: "", notes: "", done: false });
      saveState(state);
      render();
    }

    function duplicateLast(exIndex) {
      ensureTodayLog();
      const today = getTodayKey();
      const sets = state.logs[today].exercises[exIndex].sets;
      const last = sets[sets.length - 1];
      sets.push({ ...last, done: false });
      saveState(state);
      render();
    }

    function saveWorkout(markComplete) {
      ensureTodayLog();
      const today = getTodayKey();
      const log = state.logs[today];
      log.completed = markComplete;
      log.totalVolume = calculateVolume(log);
      log.loggedAt = today;
      log.units = state.units;
      saveState(state);
      render();
    }

    function calculateVolume(log) {
      let total = 0;
      log.exercises.forEach(ex => {
        ex.sets.forEach(set => {
          const w = parseFloat(set.weight);
          const r = parseFloat(set.reps);
          if (!isNaN(w) && !isNaN(r)) total += w * r;
        });
      });
      return total;
    }

    function buildWorkoutSummary(log) {
      if (!log) return null;
      const exerciseVolumes = new Map();
      let totalSets = 0;
      const prHighlights = [];
      log.exercises.forEach(ex => {
        const name = ex.selectedName || ex.name;
        let volume = 0;
        const best = getBestSet(ex.sets);
        const priorPR = getExercisePR(name, log.loggedAt || getTodayKey());
        if (best && (!priorPR || best.e1rm > priorPR.best1rm)) {
          prHighlights.push({ name, weight: best.weight, reps: best.reps, e1rm: best.e1rm });
        }
        ex.sets.forEach(set => {
          const w = parseFloat(set.weight);
          const r = parseFloat(set.reps);
          if (!isNaN(w) && !isNaN(r)) {
            totalSets += 1;
          } else if (set.done) {
            totalSets += 1;
          }
          if (!isNaN(w) && !isNaN(r)) volume += w * r;
        });
        if (volume > 0) {
          exerciseVolumes.set(name, (exerciseVolumes.get(name) || 0) + volume);
        }
      });
      return {
        totalVolume: calculateVolume(log),
        totalSets,
        prHighlights,
        exerciseVolumes: Array.from(exerciseVolumes.entries())
          .map(([name, volume]) => ({ name, volume }))
          .sort((a, b) => b.volume - a.volume)
      };
    }

    function resetToday() {
      const today = getTodayKey();
      delete state.logs[today];
      saveState(state);
      render();
    }

    function setActiveProgram(programId) {
      state.activeProgramId = programId;
      state.programStart = getTodayKey();
      saveState(state);
      render();
    }

    function toggleFavorite(programId) {
      const favorites = new Set(state.favorites || []);
      if (favorites.has(programId)) {
        favorites.delete(programId);
      } else {
        favorites.add(programId);
      }
      state.favorites = Array.from(favorites);
      saveState(state);
      render();
    }

    function setProgramFilter(category) {
      state.programFilter = category;
      saveState(state);
      render();
    }

    function previewProgram(programId) {
      const program = state.programs.find(p => p.id === programId);
      if (!program) return;
      alert(program.days.map(day => `${day.name}: ${day.exercises.map(ex => ex.name).join(', ') || 'No exercises yet'}`).join('\n\n'));
    }

    function updateStartDate(value) {
      state.programStart = value;
      saveState(state);
      render();
    }

    function setActiveDate(value) {
      state.activeDate = value;
      state.calendarMonth = value.slice(0, 7);
      saveState(state);
      render();
    }

    function goToToday() {
      const todayKey = formatDateKey(new Date());
      state.activeDate = todayKey;
      state.calendarMonth = todayKey.slice(0, 7);
      saveState(state);
      render();
    }

    function setUnits(value) {
      state.units = value;
      saveState(state);
      render();
    }

    function formatVolume(value) {
      const unit = state.units || "lb";
      const factor = unit === "kg" ? 0.453592 : 1;
      return `${Math.round(value * factor)} ${unit}`;
    }

    function updateDayOverride(value) {
      const today = getTodayKey();
      state.dayOverrides = state.dayOverrides || {};
      state.dayOverrides[today] = parseInt(value, 10);
      delete state.logs[today];
      saveState(state);
      render();
    }

    function clearDayOverride() {
      const today = getTodayKey();
      if (state.dayOverrides) {
        delete state.dayOverrides[today];
      }
      delete state.logs[today];
      saveState(state);
      render();
    }

    function exportData() {
      const data = JSON.stringify(state, null, 2);
      navigator.clipboard.writeText(data).then(() => {
        alert("Data copied to clipboard. Save it anywhere you like.");
      });
    }

    function importData() {
      const data = prompt("Paste your exported data JSON here:");
      if (!data) return;
      try {
        state = JSON.parse(data);
        saveState(state);
        render();
      } catch (err) {
        alert("That didn't look like valid data.");
      }
    }

    function getSelectedExerciseName(exIndex, exercise, log) {
      return log?.exercises?.[exIndex]?.selectedName || exercise.name;
    }

    function getBestSet(sets) {
      let best = null;
      sets.forEach(set => {
        const w = parseFloat(set.weight);
        const r = parseFloat(set.reps);
        if (isNaN(w) || isNaN(r)) return;
        const e1rm = w * (1 + r / 30);
        if (!best || e1rm > best.e1rm) {
          best = { weight: w, reps: r, e1rm };
        }
      });
      return best;
    }

    function getExerciseHistory(exerciseName, limit = 3, excludeDate = null) {
      const entries = Object.entries(state.logs)
        .filter(([_, log]) => log.exercises)
        .filter(([date]) => (excludeDate ? date !== excludeDate : true))
        .map(([date, log]) => {
          const ex = log.exercises.find(item => (item.selectedName || item.name) === exerciseName);
          return {
            date,
            bestSet: ex ? getBestSet(ex.sets) : null
          };
        })
        .filter(entry => entry.bestSet)
        .sort((a,b) => b.date.localeCompare(a.date))
        .slice(0, limit);

      return entries.map(entry => ({
        date: entry.date,
        weight: entry.bestSet.weight,
        reps: entry.bestSet.reps,
        e1rm: entry.bestSet.e1rm
      }));
    }

    function getExercisePR(exerciseName, excludeDate = null) {
      const history = getExerciseHistory(exerciseName, 999, excludeDate);
      if (history.length === 0) return null;
      let best = history[0];
      history.forEach(entry => {
        if (entry.e1rm > best.e1rm) best = entry;
      });
      return { ...best, best1rm: best.e1rm };
    }

    function renderHistoryPreview(history) {
      if (!history.length) return "";
      return `
        <div style="margin-top:10px">
          <div class="inline-note">Last ${history.length} sessions</div>
          <table>
            <thead>
              <tr><th>Date</th><th>Best Set</th><th>Est. 1RM</th></tr>
            </thead>
            <tbody>
              ${history.map(entry => `
                <tr>
                  <td>${formatDate(entry.date)}</td>
                  <td>${entry.weight} x ${entry.reps}</td>
                  <td>${entry.e1rm.toFixed(1)}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function buildSelectOptions(options, selected) {
      return options.map(option => `
        <option value="${escapeHtml(option)}" ${option === selected ? "selected" : ""}>
          ${escapeHtml(option)}
        </option>
      `).join("");
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function buildExerciseTrends() {
      const map = new Map();
      Object.entries(state.logs).forEach(([date, log]) => {
        log.exercises?.forEach(ex => {
          ex.sets.forEach(set => {
            const w = parseFloat(set.weight);
            const r = parseFloat(set.reps);
            if (isNaN(w) || isNaN(r)) return;
            const e1rm = w * (1 + r / 30);
            const name = ex.selectedName || ex.name;
            const current = map.get(name) || { name, best1rm: 0, lastWeight: w, lastReps: r, lastDate: date };
            current.best1rm = Math.max(current.best1rm, e1rm);
            if (date >= current.lastDate) {
              current.lastWeight = w;
              current.lastReps = r;
              current.lastDate = date;
            }
            map.set(name, current);
          });
        });
      });
      return Array.from(map.values()).sort((a,b) => b.best1rm - a.best1rm).slice(0, 8);
    }

    function drawChart(exercises) {
      const canvas = document.getElementById("chart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const width = canvas.clientWidth;
      const height = canvas.clientHeight;
      canvas.width = width;
      canvas.height = height;
      ctx.clearRect(0,0,width,height);
      ctx.strokeStyle = "#4dd2ff";
      ctx.lineWidth = 2;

      const values = exercises.map(x => x.best1rm);
      if (values.length === 0) {
        ctx.fillStyle = "#9bb0c9";
        ctx.fillText("Log workouts to see trends", 10, 30);
        return;
      }
      const max = Math.max(...values);
      const min = Math.min(...values);
      const pad = 10;

      values.forEach((v, i) => {
        const x = pad + i * ((width - pad * 2) / Math.max(values.length - 1, 1));
        const y = height - pad - ((v - min) / Math.max(max - min, 1)) * (height - pad * 2);
        if (i === 0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    function renderSelectedDaySummary() {
      const dateKey = state.activeDate || formatDateKey(new Date());
      const log = state.logs[dateKey];
      const summary = log ? buildWorkoutSummary(log) : null;

      if (!log) {
        return `
          <div class="inline-note">No workout logged for ${formatDate(dateKey)}.</div>
          <div class="row" style="margin-top:10px">
            <button class="btn secondary" onclick="switchTab('today')">Go to Day</button>
          </div>
        `;
      }

      return `
        <div class="row" style="justify-content: space-between">
          <div>
            <div class="inline-note">${formatDate(dateKey)}</div>
            <div>${log.programName || ""} · ${log.workoutName || ""}</div>
          </div>
          <span class="tag">${formatVolume(log.totalVolume ?? calculateVolume(log))}</span>
        </div>
        <div class="row" style="margin-top:8px">
          <span class="pill">Sets: ${summary?.totalSets ?? 0}</span>
          ${summary?.prHighlights?.length ? `<span class="pill">PRs: ${summary.prHighlights.length}</span>` : ""}
        </div>
        <div style="margin-top:10px">
          ${(summary?.exerciseVolumes || []).slice(0, 3).map(item => `
            <div class="inline-note">${item.name}: ${Math.round(item.volume)} lb</div>
          `).join("") || '<div class="inline-note">No logged volume yet.</div>'}
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn secondary" onclick="switchTab('today')">Go to Day</button>
        </div>
      `;
    }

    function buildCalendar(activeDate) {
      const [monthYear, monthNum] = (state.calendarMonth || formatDateKey(activeDate).slice(0, 7)).split("-");
      const currentMonth = new Date(Number(monthYear), Number(monthNum) - 1, 1);
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const firstDay = new Date(year, month, 1);
      const startDay = firstDay.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const todayKey = formatDateKey(new Date());
      const selectedKey = state.activeDate || todayKey;

      const cells = [];
      for (let i = 0; i < startDay; i += 1) {
        cells.push({ day: "", dateKey: "", hasLog: false, isToday: false, isSelected: false, disabled: true });
      }
      for (let day = 1; day <= daysInMonth; day += 1) {
        const dateKey = formatDateKey(new Date(year, month, day));
        cells.push({
          day,
          dateKey,
          hasLog: Boolean(state.logs[dateKey]),
          isToday: dateKey === todayKey,
          isSelected: dateKey === selectedKey,
          disabled: false
        });
      }

      return {
        label: currentMonth.toLocaleDateString(undefined, { month: "long", year: "numeric" }),
        weekdays: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
        cells
      };
    }

    function changeCalendarMonth(direction) {
      const currentKey = state.calendarMonth || (state.activeDate || formatDateKey(new Date())).slice(0, 7);
      const [yearStr, monthStr] = currentKey.split("-");
      const base = new Date(Number(yearStr), Number(monthStr) - 1, 1);
      const next = new Date(base.getFullYear(), base.getMonth() + direction, 1);
      const nextKey = `${next.getFullYear()}-${String(next.getMonth() + 1).padStart(2, "0")}`;
      state.calendarMonth = nextKey;
      saveState(state);
      render();
    }

    function formatDate(dateKey) {
      const date = new Date(dateKey + "T00:00:00");
      return date.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" });
    }

    function updateSubtitle() {
      const el = document.getElementById("subtitle");
      if (!el) return;
      const dateKey = state.activeDate || formatDateKey(new Date());
      el.textContent = `Build ${APP_VERSION} · ${formatDate(dateKey)}`;
    }

    let timerInterval = null;
    function timerStart(seconds) {
      timerStop();
      let remaining = seconds;
      updateTimerDisplay(remaining);
      timerInterval = setInterval(() => {
        remaining -= 1;
        if (remaining <= 0) {
          timerStop();
          updateTimerDisplay(0);
          return;
        }
        updateTimerDisplay(remaining);
      }, 1000);
    }

    function timerStop() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
    }

    function updateTimerDisplay(seconds) {
      const el = document.getElementById("rest-timer");
      if (!el) return;
      const m = String(Math.floor(seconds / 60)).padStart(2, "0");
      const s = String(seconds % 60).padStart(2, "0");
      el.textContent = `${m}:${s}`;
    }

    function switchTab(target) {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      const tab = document.querySelector(`.tab[data-view="${target}"]`);
      if (tab) tab.classList.add("active");
      document.querySelectorAll(".view").forEach(view => view.style.display = "none");
      const activeView = document.getElementById(`view-${target}`);
      if (activeView) activeView.style.display = "block";
    }

    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        switchTab(tab.dataset.view);
      });
    });

    render();
  </script>
</body>
</html>
